{"version":3,"file":"SearchForm-CB7G4hh6.js","sources":["../../../packages/materials/Scene/SearchForm/SearchForm.tsx"],"sourcesContent":["import React, { forwardRef, useCallback, useEffect, useImperativeHandle, useRef, useState } from 'react';\nimport { Button, ButtonProps, Form, Space } from 'antd';\nimport { ComponentType } from '@materials/types';\nimport MarsRender from '@materials/MarsRender/MarsRender';\nimport { DownOutlined, UpOutlined, SearchOutlined, RedoOutlined } from '@ant-design/icons';\nimport * as icons from '@ant-design/icons';\nimport { usePageStore } from '@materials/stores/pageStore';\nimport { FormContext } from '@materials/utils/context';\nimport { dateFormat, getDateByType, getDateRangeByType, isNotEmpty } from '@materials/utils/util';\nimport { handleActionFlow } from '@materials/utils/action';\nimport dayjs from 'dayjs';\nimport styles from './index.module.less';\nexport interface IConfig {\n  form: {\n    submitText: string;\n    resetText: string;\n  };\n  bulkActionList?: Array<ButtonProps & { text: string; eventName: string; icon: string }>;\n}\n/**\n *\n * @param props 组件本身属性\n * @param style 组件样式\n * @param attr 组件其它属性，比如：id、type、className\n * @returns\n */\nconst SearchForm = ({ id, type, config, elements, onSearch, onChange, onReset }: ComponentType<IConfig>, ref: any) => {\n  const [form] = Form.useForm();\n  const emptyRef = useRef<HTMLDivElement>(null);\n  const [isExpand, setIsExpand] = useState(false);\n  const [isMore, setIsMore] = useState(false);\n  const [visible, setVisible] = useState(true);\n  const [initialValues, setInitialValues] = useState({});\n\n  const { formData, setFormData } = usePageStore((state) => ({\n    formData: state.page.pageData.formData,\n    setFormData: state.setFormData,\n  }));\n\n  // 初始化表单值\n  useEffect(() => {\n    setTimeout(() => {\n      // 判断是否显示更多按钮\n      if ((emptyRef.current?.offsetTop as number) >= 32 && elements.length > 0) {\n        setIsMore(true);\n      } else {\n        setIsMore(false);\n      }\n    }, 500);\n  }, [elements]);\n\n  // 提交表单\n  const handleSearch = () => {\n    const values = form.getFieldsValue();\n    onSearch && onSearch(dateFormat(elements, values));\n  };\n  // 重置表单\n  const handleReset = () => {\n    form.resetFields();\n    const values = form.getFieldsValue();\n    onReset && onReset(dateFormat(elements, values));\n    setFormData({\n      name: id,\n      value: values,\n      type: 'override',\n    });\n  };\n\n  // 监听表单值变化\n  const handleValuesChange = (_: any, allValues: any) => {\n    const values = dateFormat(elements, allValues);\n    onChange?.(values);\n    setFormData({\n      name: id,\n      value: values,\n    });\n  };\n\n  useImperativeHandle(ref, () => ({\n    show() {\n      setVisible(true);\n    },\n    hide() {\n      setVisible(false);\n    },\n    reset() {\n      form.resetFields();\n      setFormData({\n        name: id,\n        value: form.getFieldsValue(),\n        type: 'override',\n      });\n    },\n    submit() {\n      form.submit();\n    },\n    init(values: any = {}) {\n      const initData = dateFormat(elements, values);\n      form.setFieldsValue(initData);\n      setFormData({\n        name: id,\n        value: initData,\n      });\n    },\n    getFormData(key: string) {\n      if (key && typeof key === 'string') {\n        return formData[id]?.[key];\n      }\n      return formData[id];\n    },\n  }));\n\n  /**\n   * 操作按钮点击\n   */\n  const handleOperate = (eventName: string) => {\n    const values = form.getFieldsValue();\n    const transformValue = dateFormat(elements, values);\n    const btnEvent = config.events.find((event) => event.eventName === eventName);\n    handleActionFlow(btnEvent?.actions, transformValue);\n  };\n\n  // 展开收起\n  const toggleExpand = () => {\n    setIsExpand(!isExpand);\n  };\n\n  // 查询和重置按钮\n  const { submitText, resetText } = config.props.form || {};\n  // 批量操作按钮\n  const bulkActionList = config.props.bulkActionList || [];\n  // 设置默认值\n  const initValues = useCallback((type: string, name: string, value: any) => {\n    if (name && isNotEmpty(value)) {\n      let initValue = value;\n      if (type === 'InputNumber') initValue = Number(value);\n      if (type === 'DatePicker') initValue = getDateByType(value);\n      if (type === 'DatePickerRange') initValue = getDateRangeByType(value);\n      if (type === 'TimePicker') initValue = dayjs(value, 'HH:mm:ss');\n      setInitialValues({ [name]: initValue });\n      form.setFieldValue([name], initValue);\n      setFormData({\n        name: id,\n        value: { [name]: initValue },\n      });\n    }\n  }, []);\n  const iconsList: { [key: string]: any } = icons;\n  return (\n    visible && (\n      <FormContext.Provider value={{ initValues }}>\n        <Form form={form} layout=\"inline\" style={config.style} initialValues={initialValues} onValuesChange={handleValuesChange}>\n          <div className={styles.formWrap} style={!isExpand ? { height: 32, overflow: 'hidden' } : {}}>\n            <MarsRender elements={elements} />\n            <div ref={emptyRef}></div>\n          </div>\n          <Space style={{ alignItems: 'baseline', marginLeft: 10 }}>\n            {submitText ? (\n              <Button type=\"primary\" icon={<SearchOutlined />} onClick={handleSearch}>\n                {submitText}\n              </Button>\n            ) : null}\n\n            {resetText ? (\n              <Button type=\"default\" icon={<RedoOutlined />} onClick={handleReset}>\n                {resetText}\n              </Button>\n            ) : null}\n\n            {bulkActionList.length > 0 && (\n              <div className={styles.action}>\n                {config.props.bulkActionList?.map((item, index) => {\n                  return (\n                    <Button\n                      type={item.type}\n                      danger={item.danger}\n                      icon={item.icon ? React.createElement(iconsList[item.icon]) : null}\n                      onClick={() => handleOperate(item.eventName)}\n                      key={`bulkAction${index}`}\n                    >\n                      {item.text}\n                    </Button>\n                  );\n                })}\n              </div>\n            )}\n            {isMore && (\n              <Button type=\"link\" icon={isExpand ? <UpOutlined /> : <DownOutlined />} onClick={toggleExpand}>\n                {isExpand ? '收起' : '展开'}\n              </Button>\n            )}\n          </Space>\n        </Form>\n      </FormContext.Provider>\n    )\n  );\n};\nexport default forwardRef(SearchForm);\n"],"names":["SearchForm","id","type","config","elements","onSearch","onChange","onReset","ref","form","Form","emptyRef","useRef","isExpand","setIsExpand","useState","isMore","setIsMore","visible","setVisible","initialValues","setInitialValues","formData","setFormData","usePageStore","state","useEffect","_a","handleSearch","values","dateFormat","handleReset","handleValuesChange","_","allValues","useImperativeHandle","initData","key","handleOperate","eventName","transformValue","btnEvent","event","handleActionFlow","toggleExpand","submitText","resetText","bulkActionList","initValues","useCallback","name","value","isNotEmpty","initValue","getDateByType","getDateRangeByType","dayjs","iconsList","icons","jsx","FormContext","jsxs","styles","MarsRender","Space","Button","SearchOutlined","RedoOutlined","item","index","React","UpOutlined","DownOutlined","forwardRef"],"mappings":"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"}